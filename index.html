<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LawFlash Updates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; color:#222; transition:0.3s; }
    header { background:#222; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; }
    #tabs { display:flex; flex-wrap:wrap; background:#444; }
    #tabs button { flex:1; padding:10px; border:none; background:#444; color:#fff; cursor:pointer; }
    #tabs button.active { background:#222; }
    .content { padding:10px; }
    .card { background:#fff; margin:10px 0; padding:10px; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .card h3 { margin:0 0 5px; }
    .card a { text-decoration:none; color:#0066cc; display:inline-block; margin-right:8px; }
    .dark { background:#111; color:#eee; }
    .dark .card { background:#222; }
    .btn { padding:4px 8px; margin:3px; border:none; border-radius:4px; cursor:pointer; background:#0066cc; color:#fff; font-size:12px; }
    .btn:hover { background:#004999; }
  </style>
</head>
<body>
  <header>
    <h1>‚öñÔ∏è LawFlash</h1>
    <button id="toggleNight" class="btn">üåô Night</button>
  </header>

  <div id="tabs">
    <button onclick="showTab('lawweb')" class="active">LawWeb</button>
    <button onclick="showTab('livelaw')">LiveLaw</button>
    <button onclick="showTab('verdictum')">Verdictum</button>
    <button onclick="showTab('ipleaders')">iPleaders</button>
    <button onclick="showTab('barbench')">Bar&Bench</button>
    <button onclick="showTab('supremetoday')">SupremeToday</button>
    <button onclick="showTab('scconline')">SCC Online</button>
    <button onclick="showTab('favorites')">‚≠ê Favorites</button>
  </div>

  <div id="content" class="content"></div>

  <script>
    const feeds = {
      lawweb: "https://lawweb.in/feeds/posts/default?alt=rss",
      livelaw: "https://www.livelaw.in/rssfeed",
      verdictum: "https://verdictum.in/rssfeed",
      ipleaders: "https://blog.ipleaders.in/feed/",
      barbench: "https://www.barandbench.com/rss",
      supremetoday: "https://www.supremetoday.ai/rss",
      scconline: "https://www.scconline.com/blog/post/feed/"
    };

    let currentTab = "lawweb";

    function showTab(tab) {
      document.querySelectorAll("#tabs button").forEach(b => b.classList.remove("active"));
      document.querySelector(`#tabs button[onclick="showTab('${tab}')"]`).classList.add("active");
      currentTab = tab;
      if (tab === "favorites") {
        renderFavorites();
      } else {
        loadFeed(tab);
      }
    }

    function loadFeed(tab) {
      const cache = getCachedFeed(tab);
      if (cache) {
        renderFeed(tab, cache, true);
        fetchFeed(tab, true); // background refresh
      } else {
        fetchFeed(tab);
      }
    }

    function fetchFeed(tab, silent=false) {
      fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(feeds[tab]))
        .then(r => r.json())
        .then(data => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(data.contents, "text/xml");
          const items = [...xml.querySelectorAll("item")].slice(0, 10).map(item => ({
            title: item.querySelector("title")?.textContent || "No title",
            link: item.querySelector("link")?.textContent || "#",
            description: item.querySelector("description")?.textContent || "",
            pdf: (item.querySelector("link")?.textContent.endsWith(".pdf")) ? item.querySelector("link").textContent : null
          }));
          cacheFeed(tab, items);
          renderFeed(tab, items);
        })
        .catch(() => {
          if (!silent) document.getElementById("content").innerHTML = "<p>‚ö†Ô∏è Could not load updates.</p>";
        });
    }

    function renderFeed(tab, items, cached=false) {
      const content = document.getElementById("content");
      content.innerHTML = cached ? "<p>üìÇ Showing cached results...</p>" : "";
      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${item.title}</h3>
          <p>${item.description.slice(0,150)}...</p>
          <a href="${item.link}" target="_blank">üîó Read</a>
          ${item.pdf ? `<a href="${item.pdf}" target="_blank">üìÑ PDF</a>` : ""}
          <button class="btn" onclick="saveFavorite('${tab}', '${encodeURIComponent(item.title)}', '${encodeURIComponent(item.link)}')">‚≠ê Save</button>
          <a class="btn" target="_blank" href="https://www.printfriendly.com/p/g?url=${encodeURIComponent(item.link)}">üñ®Ô∏è PDF</a>
          <a class="btn" target="_blank" href="https://gemini.google.com/app?q=${encodeURIComponent(item.title + ' site:indiankanoon.org')}">üîç Find Caselaw</a>
          <a class="btn" target="_blank" href="https://wa.me/?text=${encodeURIComponent(item.title + ' ' + item.link)}">üì§ Share</a>
        `;
        content.appendChild(card);
      });
    }

    // Favorites
    function saveFavorite(tab, title, link) {
      let favs = JSON.parse(localStorage.getItem("favorites") || "[]");
      favs.push({ tab, title: decodeURIComponent(title), link: decodeURIComponent(link) });
      localStorage.setItem("favorites", JSON.stringify(favs));
      alert("‚≠ê Added to favorites!");
    }

    function renderFavorites() {
      const content = document.getElementById("content");
      const favs = JSON.parse(localStorage.getItem("favorites") || "[]");
      content.innerHTML = favs.length ? "" : "<p>‚≠ê No favorites yet.</p>";
      favs.forEach((f,i) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${f.title}</h3>
          <a href="${f.link}" target="_blank">üîó Read</a>
          <button class="btn" onclick="removeFavorite(${i})">‚ùå Remove</button>
        `;
        content.appendChild(card);
      });
    }

    function removeFavorite(i) {
      let favs = JSON.parse(localStorage.getItem("favorites") || "[]");
      favs.splice(i,1);
      localStorage.setItem("favorites", JSON.stringify(favs));
      renderFavorites();
    }

    // Cache system
    function cacheFeed(key, data) {
      localStorage.setItem(key, JSON.stringify({ timestamp: Date.now(), items: data }));
    }

    function getCachedFeed(key, maxAge = 1000*60*30) {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (Date.now() - parsed.timestamp > maxAge) return null;
      return parsed.items;
    }

    // Night Mode
    const night = localStorage.getItem("night") === "true";
    if (night) document.body.classList.add("dark");
    document.getElementById("toggleNight").onclick = () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("night", document.body.classList.contains("dark"));
    };

    // Init
    loadFeed("lawweb");

    // Service Worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
</html>
